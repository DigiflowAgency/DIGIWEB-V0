generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model accounts {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  users             users   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model activities {
  id              String              @id
  title           String
  description     String?             @db.Text
  type            activities_type
  status          activities_status   @default(PLANIFIEE)
  priority        activities_priority @default(MOYENNE)
  scheduledAt     DateTime
  duration        Int?
  completedAt     DateTime?
  contactId       String?
  dealId          String?
  assignedToId    String
  aircallCallId   String?             @unique
  outcome         String?             // ANSWERED | VOICEMAIL | NO_ANSWER | CALLBACK | PROPOSAL_SENT
  resultNotes     String?             @db.Text
  // Champs qualification (NOUVEAU)
  temperature     String?             // HOT | WARM | COLD
  budgetDiscussed Boolean?
  decisionMaker   Boolean?
  mainObjection   String?             // PRICE | TIMING | COMPETITOR | NO_NEED | OTHER
  // Champs prochaine action (NOUVEAU)
  nextAction      String?             // CALLBACK | SEND_QUOTE | MEETING | FOLLOWUP | CLOSE
  nextActionDate  DateTime?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime
  users           users               @relation(fields: [assignedToId], references: [id], onDelete: Cascade)
  contacts        contacts?           @relation(fields: [contactId], references: [id])
  deals           deals?              @relation(fields: [dealId], references: [id])

  @@index([assignedToId])
  @@index([contactId])
  @@index([dealId])
  @@index([scheduledAt])
}

model analytics_reports {
  id          String                 @id
  type        analytics_reports_type
  website     String
  startDate   DateTime
  endDate     DateTime
  data        String                 @db.Text
  sentAt      DateTime?
  recipients  String                 @db.Text
  generatedAt DateTime               @default(now())

  @@index([type])
  @@index([website])
}

model campaigns {
  id          String           @id
  name        String
  type        campaigns_type
  status      campaigns_status @default(BROUILLON)
  budget      Float?
  spent       Float?           @default(0)
  reach       Int?             @default(0)
  clicks      Int?             @default(0)
  conversions Int?             @default(0)
  startDate   DateTime?
  endDate     DateTime?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime
}

model client_monitoring {
  id         String   @id
  clientId   String
  domain     String
  uptime     Float    @default(99.9)
  cpu        Float    @default(0)
  memory     Float    @default(0)
  ssl        Boolean  @default(true)
  lastBackup String?
  nps        Int      @default(0)
  status     String   @default("healthy")
  createdAt  DateTime @default(now())
  updatedAt  DateTime
  clients    clients  @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId], map: "client_monitoring_clientId_fkey")
}

model clients {
  id                String              @id
  contactId         String?
  companyId         String?
  ownerId           String
  name              String
  email             String
  status            clients_status      @default(ACTIF)
  contractValue     Float
  signedAt          DateTime
  renewalDate       DateTime?
  healthScore       Int                 @default(50)
  upsellOpportunity Boolean             @default(false)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime
  client_monitoring client_monitoring[]
  companies         companies?          @relation(fields: [companyId], references: [id])
  users             users               @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@index([companyId], map: "clients_companyId_fkey")
  @@index([ownerId])
  @@index([status])
}

model companies {
  id            String           @id
  name          String
  siret         String?          @unique
  legalForm     String?
  gerant        String?
  industry      String?
  employees     Int?
  revenue       Float?
  solvencyScore Int?
  solvencyDate  DateTime?
  status        companies_status @default(PROSPECT)
  address       String?
  city          String?
  postalCode    String?
  country       String?          @default("France")
  latitude      Float?
  longitude     Float?
  website       String?
  phone         String?
  email         String?
  socialMedia   String?          @db.Text
  assignedToId  String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime
  clients       clients[]
  users         users?           @relation(fields: [assignedToId], references: [id])
  contacts      contacts[]
  deals         deals[]
  notes         notes[]

  @@index([assignedToId])
  @@index([siret])
  @@index([status])
}

model contacts {
  id           String          @id
  firstName    String
  lastName     String
  email        String?
  phone        String?
  position     String?
  companyId    String?
  siret        String?
  gerant       String?
  status       contacts_status @default(LEAD)
  qualityScore Int?
  assignedToId String?
  address      String?
  city         String?
  postalCode   String?
  country      String?         @default("France")
  source       String?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime
  activities   activities[]
  users        users?          @relation(fields: [assignedToId], references: [id])
  companies    companies?      @relation(fields: [companyId], references: [id])
  deals        deals[]
  notes        notes[]
  quotes       quotes[]
  reminders    reminders[]

  @@index([assignedToId])
  @@index([companyId])
  @@index([email])
  @@index([status])
}

model custom_dashboards {
  id          String   @id
  name        String
  description String?
  widgets     Int      @default(0)
  favorite    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime
}

model deal_products {
  id          String   @id
  dealId      String
  name        String
  description String?  @db.Text
  quantity    Int      @default(1)
  unitPrice   Float
  totalPrice  Float
  createdAt   DateTime @default(now())
  deals       deals    @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([dealId])
}

model deals {
  id                 String                   @id
  title              String
  description        String?                  @db.Text
  value              Float
  currency           String                   @default("EUR")
  stage              String                   @default("A_CONTACTER")
  productionStage    deals_production_stage?
  probability        Int                      @default(50)
  expectedCloseDate  DateTime?
  closedAt           DateTime?
  lostReason         String?                  // PRICE | TIMING | COMPETITOR | NO_BUDGET | NO_RESPONSE | OTHER
  proposalSentAt     DateTime?                // Date envoi proposition
  contactId          String?
  companyId          String?
  ownerId            String
  product            String?
  origin             String?
  emailReminderSent  String?
  smsReminderSent    String?
  comments           String?                  @db.Text
  blocNotes              String?                  @db.Text
  productionServiceId    String?
  productionStageId      String?
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime
  activities             activities[]
  deal_products          deal_products[]
  companies              companies?               @relation(fields: [companyId], references: [id])
  contacts               contacts?                @relation(fields: [contactId], references: [id])
  users                  users                    @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  notes                  notes[]
  deal_assignees         deal_assignees[]
  reminders              reminders[]
  deal_documents         deal_documents[]
  stage_history          deal_stage_history[]
  productionService      production_services?     @relation(fields: [productionServiceId], references: [id])
  deal_service_assignments deal_service_assignments[]  // Multi-services

  @@index([companyId])
  @@index([contactId])
  @@index([ownerId])
  @@index([stage])
  @@index([productionStage])
  @@index([productionServiceId])
}

// Service de production (Site Web, SEO, etc.)
model production_services {
  id          String   @id @default(uuid())
  name        String
  description String?
  color       String   @default("#8B5CF6")
  position    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  stages      production_service_stages[]
  deals       deals[]
  deal_service_assignments deal_service_assignments[]  // Multi-services
}

// Colonnes/étapes d'un service de production
model production_service_stages {
  id          String   @id @default(uuid())
  serviceId   String
  name        String
  description String?
  color       String   @default("#E5E7EB")
  position    Int      @default(0)
  createdAt   DateTime @default(now())

  service     production_services @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  deal_service_assignments deal_service_assignments[]

  @@index([serviceId])
}

// Table pivot pour assigner plusieurs services à un deal (avec stage indépendant par service)
model deal_service_assignments {
  id        String   @id @default(uuid())
  dealId    String
  serviceId String
  stageId   String?  // Stage indépendant par service (nullable = non encore démarré)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deal    deals                      @relation(fields: [dealId], references: [id], onDelete: Cascade)
  service production_services        @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  stage   production_service_stages? @relation(fields: [stageId], references: [id], onDelete: SetNull)

  @@unique([dealId, serviceId])  // Un deal ne peut avoir un service qu'une fois
  @@index([dealId])
  @@index([serviceId])
  @@index([stageId])
}

// Historique des changements de stage d'un deal
model deal_stage_history {
  id          String   @id @default(uuid())
  dealId      String
  fromStage   String
  toStage     String
  changedById String
  notes       String?  @db.Text
  changedAt   DateTime @default(now())

  deal        deals    @relation(fields: [dealId], references: [id], onDelete: Cascade)
  changedBy   users    @relation("StageChangedBy", fields: [changedById], references: [id])

  @@index([dealId])
  @@index([changedById])
  @@index([changedAt])
}

// Table pivot pour assigner plusieurs utilisateurs à un deal
model deal_assignees {
  id        String   @id @default(uuid())
  dealId    String
  userId    String
  role      String?  // "principal", "support", "observateur", etc.
  createdAt DateTime @default(now())

  deal      deals    @relation(fields: [dealId], references: [id], onDelete: Cascade)
  user      users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([dealId, userId])
  @@index([dealId])
  @@index([userId])
}

// Table pour les rappels programmés (style Notion)
model reminders {
  id          String   @id @default(uuid())
  dealId      String?
  contactId   String?
  userId      String   // Qui doit être notifié
  title       String
  description String?  @db.Text
  remindAt    DateTime // Date/heure du rappel
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())
  notifiedAt  DateTime? // Date où la notification d'échéance a été envoyée

  deal    deals?    @relation(fields: [dealId], references: [id], onDelete: Cascade)
  contact contacts? @relation(fields: [contactId], references: [id], onDelete: Cascade)
  user    users     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([dealId])
  @@index([contactId])
  @@index([userId])
  @@index([remindAt])
  @@index([isRead])
}

// Table pour les documents attachés aux deals
model deal_documents {
  id         String   @id @default(uuid())
  dealId     String
  name       String   // Nom du fichier original
  fileUrl    String   // URL du fichier stocké
  fileType   String   // Type MIME (application/pdf, etc.)
  fileSize   Int      // Taille en bytes
  uploadedBy String   // userId de l'uploader
  uploadedAt DateTime @default(now())

  deal deals @relation(fields: [dealId], references: [id], onDelete: Cascade)
  user users @relation(fields: [uploadedBy], references: [id], onDelete: Cascade)

  @@index([dealId])
  @@index([uploadedBy])
}

model email_campaigns {
  id        String   @id
  subject   String
  sent      Int      @default(0)
  opened    Int      @default(0)
  clicked   Int      @default(0)
  status    String
  createdAt DateTime @default(now())
  updatedAt DateTime
}

model formation_progress {
  id           String                    @id
  userId       String
  formationId  String
  status       formation_progress_status @default(NON_COMMENCEE)
  progress     Int                       @default(0)
  startedAt    DateTime?
  completedAt  DateTime?
  lastViewedAt DateTime?
  quizScore    Int?
  formations   formations                @relation(fields: [formationId], references: [id], onDelete: Cascade)
  users        users                     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, formationId])
  @@index([formationId])
  @@index([userId])
}

model formations {
  id                 String               @id
  title              String
  description        String?              @db.Text
  category           formations_category
  videoUrl           String?
  articleContent     String?              @db.LongText
  duration           Int
  hasCertificate     Boolean              @default(false)
  allowedRoles       String               @db.Text
  order              Int                  @default(0)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  formation_progress formation_progress[]

  @@index([category])
}

model integrations {
  id            String              @id
  name          String              @unique
  status        integrations_status @default(DISCONNECTED)
  config        String              @db.Text
  lastSync      DateTime?
  syncFrequency Int?
  errorCount    Int                 @default(0)
  lastError     String?             @db.Text
  connectedAt   DateTime?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime
}

model invoice_products {
  id          String   @id
  invoiceId   String
  name        String
  description String?  @db.Text
  quantity    Int      @default(1)
  unitPrice   Float
  totalPrice  Float
  invoices    invoices @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

model invoices {
  id               String             @id
  number           String             @unique
  quoteId          String?            @unique
  clientName       String
  clientEmail      String
  clientAddress    String?            @db.Text
  subtotal         Float
  taxRate          Float              @default(20)
  taxAmount        Float
  total            Float
  status           invoices_status    @default(BROUILLON)
  issuedAt         DateTime           @default(now())
  dueAt            DateTime
  paidAt           DateTime?
  paymentMethod    String?
  ownerId          String
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  invoice_products invoice_products[]
  users            users              @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  quotes           quotes?            @relation(fields: [quoteId], references: [id])

  @@index([number])
  @@index([ownerId])
  @@index([status])
}

model knowledge_articles {
  id        String   @id
  title     String
  category  String
  content   String   @db.Text
  views     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime

  @@index([category])
}

model notes {
  id        String     @id
  content   String     @db.Text
  contactId String?
  companyId String?
  dealId    String?
  authorId  String
  createdAt DateTime   @default(now())
  updatedAt DateTime
  users     users      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  companies companies? @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contacts  contacts?  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  deals     deals?     @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([authorId])
  @@index([companyId])
  @@index([contactId])
  @@index([dealId])
}

model notifications {
  id        String             @id
  userId    String
  type      notifications_type
  title     String
  message   String             @db.Text
  link      String?
  read      Boolean            @default(false)
  readAt    DateTime?
  createdAt DateTime           @default(now())
  users     users              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([read])
  @@index([userId])
}

model products {
  id           String   @id
  name         String
  category     String
  description  String?
  price        Float
  monthlyPrice Float?
  features     String   @db.LongText
  popular      Boolean  @default(false)
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime
}

model prospects {
  id               String            @id
  name             String
  siret            String?
  activity         String
  address          String
  city             String
  postalCode       String?
  phone            String?
  email            String?
  website          String?
  employees        String?
  rating           Float?
  revenue          Float?
  // Champs d'enrichissement API
  legalForm        String?
  gerant           String?
  solvencyScore    Int?
  enrichedBy       String? // "pappers", "mlist", "manual"
  enrichedAt       DateTime?
  enrichmentData   String?           @db.Text // JSON des données brutes
  // Attribution et statut
  assignedToId     String?
  status           prospects_status  @default(A_TRAITER)
  source           String? // "csv_import", "api", "manual"
  importBatchId    String?
  qualityScore     Int? // Score de 0 à 100
  // Conversion
  contactId        String?
  companyId        String?
  convertedToDeal  Boolean           @default(false)
  convertedAt      DateTime?
  // Métadonnées
  notes            String?           @db.Text
  createdAt        DateTime          @default(now())
  updatedAt        DateTime
  users            users?            @relation(fields: [assignedToId], references: [id])
  import_batches   import_batches?   @relation(fields: [importBatchId], references: [id])

  @@index([activity])
  @@index([city])
  @@index([assignedToId])
  @@index([status])
  @@index([importBatchId])
  @@index([siret])
}

model import_batches {
  id           String    @id
  fileName     String
  totalRows    Int
  processedRows Int      @default(0)
  successRows  Int       @default(0)
  errorRows    Int       @default(0)
  status       import_batches_status @default(EN_COURS)
  uploadedById String
  assignedToId String? // Attribution automatique à un commercial
  enrichWith   String? // "pappers", "mlist", "none"
  errors       String?   @db.Text // JSON des erreurs
  createdAt    DateTime  @default(now())
  completedAt  DateTime?
  prospects    prospects[]

  @@index([status])
  @@index([uploadedById])
  @@index([assignedToId])
}

enum prospects_status {
  A_TRAITER
  A_CONTACTER
  EN_DISCUSSION
  A_RELANCER
  RDV_PRIS
  NEGO_HOT
  NON_QUALIFIE
}

enum import_batches_status {
  EN_COURS
  COMPLETE
  ERREUR
}

model quote_products {
  id          String  @id
  quoteId     String
  name        String
  description String? @db.Text
  quantity    Int     @default(1)
  unitPrice   Float
  totalPrice  Float
  // Champs pour le calculateur
  serviceId   String? // ID du service (ex: "meta-ads", "site-vitrine")
  serviceType String? // Type: website, seo, ads, social, maintenance
  period      String? // "one-time" ou "mensuel"
  channel     String? // Canal associé (meta-ads, google-ads, etc.)
  discount    Float?  @default(0) // Remise commerciale individuelle en %
  createdAt   DateTime @default(now())
  quotes      quotes  @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
}

model quotes {
  id                 String           @id
  number             String           @unique
  contactId          String?
  clientName         String
  clientEmail        String
  clientAddress      String?          @db.Text
  subtotal           Float
  taxRate            Float            @default(20)
  taxAmount          Float
  total              Float
  status             quotes_status    @default(BROUILLON)
  validityDays       Int              @default(30)
  expiresAt          DateTime?
  issuedAt           DateTime         @default(now())
  acceptedAt         DateTime?
  paymentTerms       String?          @db.Text
  notes              String?          @db.Text
  yousignId          String?
  signedAt           DateTime?
  signatureUrl       String?          @db.Text
  ownerId            String
  // Champs pour le calculateur
  commitmentPeriod   String?          @default("comptant") // "comptant", "24", "36", "48"
  isPartner          Boolean          @default(false)
  engagementDiscount Float?           @default(0) // 10%, 20%, 30% selon engagement
  partnerDiscount    Float?           @default(0) // 20% si partenaire
  oneTimeTotal       Float?           @default(0) // Total des services one-time (sites web, etc.)
  monthlyTotal       Float?           @default(0) // Total des services mensuels
  createdAt          DateTime         @default(now())
  updatedAt          DateTime
  invoices           invoices?
  quote_products     quote_products[]
  contacts           contacts?        @relation(fields: [contactId], references: [id])
  users              users            @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@index([contactId], map: "quotes_contactId_fkey")
  @@index([number])
  @@index([ownerId])
  @@index([status])
}

model reviews {
  id          String          @id
  source      reviews_source
  company     reviews_company
  rating      Int
  author      String
  content     String?         @db.Text
  reviewDate  DateTime
  response    String?         @db.Text
  respondedAt DateTime?
  externalId  String?
  importedAt  DateTime        @default(now())

  @@index([company])
  @@index([rating])
  @@index([source])
}

model sequences {
  id          String           @id
  name        String
  description String?          @db.Text
  emailsCount Int              @default(0)
  config      String           @db.Text
  enrolled    Int              @default(0)
  completed   Int              @default(0)
  openRate    Float?
  replyRate   Float?
  status      sequences_status @default(ACTIVE)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime
  lastRunAt   DateTime?

  @@index([status])
}

model sessions {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  users        users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model social_posts {
  id          String                @id
  content     String                @db.Text
  platform    social_posts_platform
  status      social_posts_status   @default(BROUILLON)
  likes       Int                   @default(0)
  comments    Int                   @default(0)
  shares      Int                   @default(0)
  reach       Int                   @default(0)
  scheduledAt DateTime?
  publishedAt DateTime?
  imageUrl    String?
  videoUrl    String?
  createdAt   DateTime              @default(now())
  updatedAt   DateTime

  @@index([platform])
  @@index([status])
}

model ticket_replies {
  id         String   @id
  ticketId   String
  authorId   String
  content    String   @db.Text
  isInternal Boolean  @default(false)
  createdAt  DateTime @default(now())
  tickets    tickets  @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
}

model tickets {
  id                                String           @id
  number                            String           @unique
  subject                           String
  description                       String           @db.Text
  type                              tickets_type     @default(CLIENT)
  status                            tickets_status   @default(OUVERT)
  priority                          tickets_priority @default(MOYENNE)
  createdById                       String
  assignedToId                      String?
  clientName                        String?
  clientEmail                       String?
  resolvedAt                        DateTime?
  responseTime                      Int?
  createdAt                         DateTime         @default(now())
  updatedAt                         DateTime
  ticket_replies                    ticket_replies[]
  users_tickets_assignedToIdTousers users?           @relation("tickets_assignedToIdTousers", fields: [assignedToId], references: [id])
  users_tickets_createdByIdTousers  users            @relation("tickets_createdByIdTousers", fields: [createdById], references: [id], onDelete: Cascade)

  @@index([assignedToId])
  @@index([createdById])
  @@index([number])
  @@index([status])
}

model users {
  id                                  String                      @id
  email                               String                      @unique
  password                            String
  firstName                           String
  lastName                            String
  role                                users_role                  @default(VENTE)
  status                              users_status                @default(ACTIVE)
  avatar                              String?
  phone                               String?
  position                            String?
  department                          String?
  managerId                           String?
  monthlyGoal                         Float?
  createdAt                           DateTime                    @default(now())
  updatedAt                           DateTime
  lastLoginAt                         DateTime?
  accounts                            accounts[]
  activities                          activities[]
  clients                             clients[]
  companies                           companies[]
  contacts                            contacts[]
  deals                               deals[]
  deal_assignees                      deal_assignees[]
  formation_progress                  formation_progress[]
  invoices                            invoices[]
  notes                               notes[]
  notifications                       notifications[]
  quotes                              quotes[]
  sessions                            sessions[]
  tickets_tickets_assignedToIdTousers tickets[]                   @relation("tickets_assignedToIdTousers")
  tickets_tickets_createdByIdTousers  tickets[]                   @relation("tickets_createdByIdTousers")
  users                               users?                      @relation("usersTousers", fields: [managerId], references: [id])
  other_users                         users[]                     @relation("usersTousers")
  goals                               goals[]                     @relation("GoalOwner")
  assignedGoals                       goals[]                     @relation("GoalAssigner")
  checkins                            checkins[]
  internal_conversations              internal_conversations[]
  conversation_participants           conversation_participants[]
  internal_messages                   internal_messages[]
  races                               races[]
  race_participants                   race_participants[]
  prospects                           prospects[]
  sales_performance                   sales_performance[]
  meta_leads                          meta_leads[]        @relation("MetaLeadsAssignedTo")
  reminders                           reminders[]
  deal_documents                      deal_documents[]
  deal_stage_changes                  deal_stage_history[]        @relation("StageChangedBy")

  @@index([email])
  @@index([managerId])
  @@index([role])
}

model verification_tokens {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model whatsapp_conversations {
  id                String              @id
  name              String
  phone             String?
  avatar            String?
  lastMessage       String?             @db.Text
  lastMessageAt     DateTime?
  unread            Int                 @default(0)
  score             Int?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime
  whatsapp_messages whatsapp_messages[]

  @@index([lastMessageAt])
}

model whatsapp_messages {
  id                     String                 @id
  conversationId         String
  text                   String                 @db.Text
  sender                 String
  sentAt                 DateTime               @default(now())
  whatsapp_conversations whatsapp_conversations @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([sentAt])
}

model workflows {
  id           String           @id
  name         String
  description  String?          @db.Text
  trigger      String
  config       String           @db.Text
  actionsCount Int              @default(0)
  executions   Int              @default(0)
  successRate  Float?
  status       workflows_status @default(ACTIVE)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime
  lastRunAt    DateTime?

  @@index([status])
}

model goals {
  id           String      @id
  userId       String?
  type         goals_type
  title        String
  description  String?     @db.Text
  targetValue  Float?
  currentValue Float?      @default(0)
  deadline     DateTime?
  completed    Boolean     @default(false)
  completedAt  DateTime?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  // Objectifs assignes par un admin a un commercial
  assignedById String?     // ID de l'admin qui a assigne l'objectif
  metricType   String?     // Type de metrique pour calcul auto (CA_MENSUEL, etc.)

  users        users?      @relation("GoalOwner", fields: [userId], references: [id], onDelete: Cascade)
  assignedBy   users?      @relation("GoalAssigner", fields: [assignedById], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([type])
  @@index([completed])
  @@index([assignedById])
}

model checkins {
  id            String    @id
  userId        String
  month         Int
  year          Int
  energy        Int
  motivation    Int
  mentalClarity String?   @db.Text
  teamAmbiance  String?   @db.Text
  pride         String?   @db.Text
  difficulties  String?   @db.Text
  vision6Months String?   @db.Text
  ideas         String?   @db.Text
  submittedAt   DateTime  @default(now())
  users         users     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, month, year])
  @@index([userId])
  @@index([month, year])
}

model daily_quotes {
  id        String   @id
  quote     String   @db.Text
  author    String
  date      DateTime @unique
  createdAt DateTime @default(now())

  @@index([date])
}

model internal_conversations {
  id                        String                      @id
  name                      String?
  isGroup                   Boolean                     @default(false)
  avatar                    String?
  lastMessage               String?                     @db.Text
  lastMessageAt             DateTime?
  createdById               String
  createdAt                 DateTime                    @default(now())
  updatedAt                 DateTime
  users                     users                       @relation(fields: [createdById], references: [id], onDelete: Cascade)
  conversation_participants conversation_participants[]
  internal_messages         internal_messages[]

  @@index([lastMessageAt])
  @@index([createdById])
}

model conversation_participants {
  id                     String                  @id
  conversationId         String
  userId                 String
  unreadCount            Int                     @default(0)
  lastReadAt             DateTime?
  joinedAt               DateTime                @default(now())
  internal_conversations internal_conversations  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  users                  users                   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([conversationId])
  @@index([userId])
}

model internal_messages {
  id                     String                 @id
  conversationId         String
  senderId               String
  content                String                 @db.Text
  attachmentUrl          String?
  attachmentName         String?
  sentAt                 DateTime               @default(now())
  internal_conversations internal_conversations @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  users                  users                  @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@index([sentAt])
}

model races {
  id                String            @id
  name              String
  description       String?           @db.Text
  startDate         DateTime
  endDate           DateTime
  metric            races_metric
  prizes            String            @db.Text // JSON: {1: "1000€", 2: "500€", 3: "250€"}
  status            races_status      @default(ACTIVE)
  createdById       String
  createdAt         DateTime          @default(now())
  updatedAt         DateTime
  users             users             @relation(fields: [createdById], references: [id], onDelete: Cascade)
  race_participants race_participants[]

  @@index([status])
  @@index([startDate, endDate])
  @@index([createdById])
}

model race_participants {
  id        String   @id
  raceId    String
  userId    String
  score     Float    @default(0)
  rank      Int?
  updatedAt DateTime @default(now())
  races     races    @relation(fields: [raceId], references: [id], onDelete: Cascade)
  users     users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([raceId, userId])
  @@index([raceId])
  @@index([userId])
  @@index([raceId, rank])
}

model sales_performance {
  id                  String    @id
  userId              String
  month               Int       // 1-12
  year                Int
  // CA et signatures
  monthlyRevenue      Float     @default(0) // CA mensuel
  yearlyRevenue       Float     @default(0) // CA annuel cumulé
  signatures          Int       @default(0) // Nombre de signatures dans le mois
  rdvCount            Int       @default(0) // Nombre de RDV pris dans le mois
  // Objectifs
  signaturesGoal      Int       @default(4)
  rdvGoal             Int       @default(20)
  objectivesReached   Boolean   @default(false)
  // Commission et primes
  monthlyCommission   Float     @default(0)  // Commission calculée
  reductionPercent    Float     @default(0)  // 0, 0.5 ou 1 (réduction appliquée)
  boosterPercent      Float     @default(0)  // Booster actuel (0, 0.05, 0.10, 0.15)
  boosterMonthsCount  Int       @default(0)  // Nombre de mois de booster cumulés
  finalMonthlyBonus   Float     @default(0)  // Prime mensuelle finale
  yearlyBonus         Float     @default(0)  // Prime annuelle calculée
  // Métadonnées
  createdAt           DateTime  @default(now())
  updatedAt           DateTime
  users               users     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, month, year])
  @@index([userId])
  @@index([month, year])
}

enum analytics_reports_type {
  WEEKLY
  MONTHLY
  CUSTOM
}

enum reviews_source {
  GOOGLE
  PAGES_JAUNES
  TRIPADVISOR
  TRUSTPILOT
}

enum integrations_status {
  CONNECTED
  DISCONNECTED
  ERROR
}

enum notifications_type {
  ACTIVITY
  DEAL
  QUOTE
  INVOICE
  TICKET
  MENTION
  SYSTEM
}

enum social_posts_platform {
  FACEBOOK
  LINKEDIN
  INSTAGRAM
  TWITTER
}

enum reviews_company {
  DIGIFLOW_AGENCY
  BE_HYPE
}

enum campaigns_type {
  EMAIL
  SOCIAL_MEDIA
  PAID_ADS
  EVENT
}

enum formations_category {
  ONBOARDING
  TECHNIQUES_VENTE
  PRODUITS
  OUTILS
  SOFT_SKILLS
  TECHNICAL
}

enum activities_type {
  APPEL
  EMAIL
  REUNION
  VISIO
}

enum social_posts_status {
  BROUILLON
  PLANIFIE
  PUBLIE
}

enum formation_progress_status {
  NON_COMMENCEE
  EN_COURS
  COMPLETEE
}

enum campaigns_status {
  BROUILLON
  PLANIFIEE
  ACTIVE
  TERMINEE
  PAUSE
}

enum tickets_type {
  INTERNAL
  CLIENT
}

enum activities_status {
  PLANIFIEE
  COMPLETEE
  ANNULEE
}

enum deals_stage {
  A_CONTACTER
  EN_DISCUSSION
  A_RELANCER
  RDV_PRIS
  NEGO_HOT
  CLOSING
  REFUSE
}

enum deals_production_stage {
  PREMIER_RDV
  EN_PRODUCTION
  LIVRE
  ENCAISSE
}

enum tickets_status {
  OUVERT
  EN_COURS
  EN_ATTENTE
  ESCALADE
  RESOLU
  FERME
}

enum activities_priority {
  HAUTE
  MOYENNE
  BASSE
}

enum users_role {
  ADMIN
  VENTE
  MARKETING
  ACCOUNT_MANAGEMENT
}

enum clients_status {
  ACTIF
  INACTIF
  CHURN
}

enum tickets_priority {
  HAUTE
  MOYENNE
  BASSE
}

enum users_status {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum workflows_status {
  ACTIVE
  PAUSE
  ARCHIVED
}

enum contacts_status {
  LEAD
  PROSPECT
  CLIENT
}

enum sequences_status {
  ACTIVE
  PAUSE
  ARCHIVED
}

enum quotes_status {
  BROUILLON
  ENVOYE
  ACCEPTE
  REFUSE
  EXPIRE
}

enum companies_status {
  LEAD
  PROSPECT
  CLIENT
}

enum invoices_status {
  BROUILLON
  ENVOYEE
  PAYEE
  EN_ATTENTE
  EN_RETARD
  ANNULEE
}

enum goals_type {
  PERSONAL
  SYSTEM
}

enum races_metric {
  CA_ENCAISSE
  DEALS_GAGNES
  CONTACTS_CREES
  ACTIVITES
  APPELS
  EMAILS
  REUNIONS
}

enum races_status {
  ACTIVE
  COMPLETED
  CANCELLED
}

// ============================================
// META LEADS (Facebook Ads)
// ============================================

model meta_leads {
  id              String            @id @default(cuid())
  metaLeadId      String            @unique // ID du lead côté Meta
  formId          String?           // ID du formulaire
  formName        String?
  pageId          String?           // ID de la page Facebook
  pageName        String?           // Nom de la page (entreprise)
  adId            String?
  adName          String?
  adsetId         String?           // ID de l'ensemble de publicités
  adsetName       String?           // Nom de l'ensemble de publicités
  campaignId      String?
  campaignName    String?
  platform        String?           // facebook, instagram, messenger
  isOrganic       Boolean?          // true si post organique (pas une pub)

  // Données du lead
  fullName        String?
  email           String?
  phone           String?
  customFields    Json?             // Autres champs du formulaire

  // Gestion interne
  status          meta_lead_status  @default(LIBRE)
  assignedToId    String?
  assignedTo      users?            @relation("MetaLeadsAssignedTo", fields: [assignedToId], references: [id])
  convertedToDeal Boolean           @default(false)
  dealId          String?

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  metaCreatedAt   DateTime?         // Date de création côté Meta

  @@index([status])
  @@index([assignedToId])
  @@index([metaCreatedAt])
  @@index([pageId])
}

enum meta_lead_status {
  LIBRE
  ASSIGNE
  CONVERTI
}

// ============================================
// PIPELINE STAGES (Colonnes dynamiques CRM)
// ============================================

model pipeline_stages {
  id          String   @id @default(cuid())
  code        String   @unique  // "A_CONTACTER", "NOUVEAU_STAGE"
  label       String             // "À Contacter"
  color       String             // "bg-gray-100 border-gray-300"
  probability Int      @default(50)  // 0-100
  position    Int                // Ordre d'affichage
  isDefault   Boolean  @default(false)  // Stage par défaut pour nouveaux deals
  isWonStage  Boolean  @default(false)  // Stage "gagné" (ex: CLOSING)
  isLostStage Boolean  @default(false)  // Stage "perdu" (ex: REFUSE)
  isActive    Boolean  @default(true)   // Masquer sans supprimer
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([position])
  @@index([isActive])
}

// ============================================
// ENTERPRISE OBJECTIVES (Objectifs Entreprise)
// ============================================

model enterprise_objectives {
  id            String                @id @default(cuid())

  // Type d'objectif predefini
  metricType    ObjectiveMetricType

  // Periode
  period        ObjectivePeriod       @default(MONTHLY)
  year          Int
  month         Int?                  // 1-12 (null si quarterly/yearly)
  quarter       Int?                  // 1-4 (null si monthly/yearly)

  // Valeurs
  targetValue   Float                 // Objectif cible
  currentValue  Float                 @default(0) // Valeur actuelle (calculee auto)

  // Metadata
  title         String
  description   String?               @db.Text
  isActive      Boolean               @default(true)

  // Timestamps
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  calculatedAt  DateTime?             // Derniere mise a jour auto

  @@unique([metricType, period, year, month])
  @@index([year, month])
  @@index([metricType])
  @@index([isActive])
}

enum ObjectiveMetricType {
  CA_MENSUEL        // Chiffre d'affaires encaisse
  CA_GENERE         // Chiffre d'affaires genere (deals signes)
  NOUVEAUX_DEALS    // Nombre de nouveaux deals
  RDV_REALISES      // Nombre de RDV effectues
  APPELS_EFFECTUES  // Nombre d'appels passes
  DEVIS_ENVOYES     // Nombre de devis envoyes
  TAUX_CONVERSION   // Pourcentage conversion
  CUSTOM            // Objectif personnalise
}

enum ObjectivePeriod {
  MONTHLY
  QUARTERLY
  YEARLY
}

// ============================================
// APP SETTINGS (Configuration globale)
// ============================================

model app_settings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt

  @@index([key])
}
